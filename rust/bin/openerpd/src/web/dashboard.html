<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenERP — Dashboard</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:oklch(.145 0 0);--card:oklch(.178 0 0);--card-fg:oklch(.985 0 0);
  --border:oklch(.274 0 0);--input:oklch(.274 0 0);
  --primary:oklch(.985 0 0);--primary-fg:oklch(.205 0 0);
  --muted:oklch(.274 0 0);--muted-fg:oklch(.556 0 0);
  --accent:oklch(.274 0 0);--accent-fg:oklch(.985 0 0);
  --destructive:oklch(.577 .245 27.325);
  --success:oklch(.696 .17 162.48);--warning:oklch(.769 .189 70.08);
  --ring:oklch(.708 0 0);--radius:.625rem;--sidebar-w:220px;
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans',Helvetica,Arial,sans-serif
}
body{font-family:var(--font);background:var(--bg);color:var(--card-fg);min-height:100vh;display:flex;flex-direction:column;font-size:14px;line-height:1.5}

/* ─── Top bar ─── */
.topbar{height:48px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0}
.topbar .logo{font-size:15px;font-weight:600;letter-spacing:-.02em;display:flex;align-items:center;gap:6px;cursor:pointer;position:relative}
.topbar .logo svg{width:18px;height:18px;fill:currentColor;opacity:.9}
.topbar .sep{width:1px;height:24px;background:var(--border)}
.module-btn{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:calc(var(--radius) - 2px);font-size:13px;font-weight:500;cursor:pointer;transition:background .1s;background:transparent;border:none;color:var(--card-fg)}
.module-btn:hover{background:var(--accent)}
.module-btn.active{background:var(--accent)}
.module-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.topbar-spacer{flex:1}
.topbar .user-name{font-size:13px;color:var(--muted-fg)}
.btn-ghost{height:32px;padding:0 10px;border:none;border-radius:calc(var(--radius) - 2px);background:transparent;color:var(--muted-fg);font-size:13px;cursor:pointer;transition:background .1s;display:inline-flex;align-items:center;gap:4px}
.btn-ghost:hover{background:var(--accent);color:var(--card-fg)}

/* ─── Mega menu ─── */
.mega-overlay{position:fixed;inset:0;z-index:50;display:none}
.mega-overlay.open{display:block}
.mega-menu{position:absolute;top:48px;left:16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;box-shadow:0 8px 32px oklch(0 0 0/.5);display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:20px;min-width:400px;z-index:51}
.mega-module h3{font-size:12px;font-weight:600;color:var(--muted-fg);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}
.mega-module a{display:block;padding:4px 0;font-size:13px;color:var(--card-fg);text-decoration:none;cursor:pointer;transition:color .1s}
.mega-module a:hover{color:var(--primary)}

/* ─── Layout ─── */
.layout{display:flex;flex:1;min-height:0}
.sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);border-right:1px solid var(--border);padding:8px;overflow-y:auto}
.sidebar .nav-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:calc(var(--radius) - 2px);font-size:13px;color:var(--muted-fg);cursor:pointer;transition:background .1s,color .1s;user-select:none}
.sidebar .nav-item:hover{background:var(--accent);color:var(--accent-fg)}
.sidebar .nav-item.active{background:var(--accent);color:var(--accent-fg);font-weight:500}
.content{flex:1;overflow-y:auto;padding:24px;min-width:0}

/* ─── Section ─── */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.section-header h2{font-size:16px;font-weight:600;letter-spacing:-.01em}

/* ─── Table ─── */
.table-card{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
table{width:100%;border-collapse:collapse}
thead tr{border-bottom:1px solid var(--border)}
th{text-align:left;padding:10px 16px;font-size:13px;font-weight:500;color:var(--muted-fg)}
td{padding:10px 16px;border-bottom:1px solid var(--border);font-size:13px}
tr:last-child td{border-bottom:none}
tbody tr{transition:background .1s}
tbody tr:hover{background:oklch(.2 0 0/.4)}
.empty-cell{text-align:center;color:var(--muted-fg);padding:32px 16px}
.mono{font-family:'SF Mono',SFMono-Regular,ui-monospace,monospace;font-size:12px}

/* ─── Buttons ─── */
.btn-sm-primary{height:36px;padding:0 14px;border:none;border-radius:calc(var(--radius) - 2px);background:var(--primary);color:var(--primary-fg);font-size:13px;font-weight:500;cursor:pointer;transition:opacity .15s;display:inline-flex;align-items:center;gap:5px}
.btn-sm-primary:hover{opacity:.9}
.btn-ghost-destructive{height:28px;padding:0 8px;border:none;border-radius:calc(var(--radius) - 4px);background:transparent;color:var(--destructive);font-size:12px;cursor:pointer;transition:background .1s}
.btn-ghost-destructive:hover{background:oklch(.577 .245 27.325/.1)}

/* ─── Dialog ─── */
.dialog-overlay{position:fixed;inset:0;background:oklch(0 0 0/.8);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s}
.dialog-overlay.open{opacity:1;pointer-events:auto}
.dialog{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:480px;padding:24px;box-shadow:0 16px 48px oklch(0 0 0/.5);transform:scale(.96) translateY(8px);transition:transform .15s;max-height:85vh;overflow-y:auto}
.dialog-overlay.open .dialog{transform:scale(1) translateY(0)}
.dialog h2{font-size:18px;font-weight:600;margin-bottom:16px}
.field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
.field label{font-size:13px;font-weight:500}
.field input,.field select{width:100%;height:36px;padding:0 10px;background:transparent;border:1px solid var(--input);border-radius:calc(var(--radius) - 2px);color:var(--card-fg);font-size:13px;outline:none;transition:border-color .15s}
.field input:focus{border-color:var(--ring)}
.dialog-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
.btn-sm-secondary{height:36px;padding:0 14px;border:1px solid var(--border);border-radius:calc(var(--radius) - 2px);background:transparent;color:var(--card-fg);font-size:13px;cursor:pointer}

/* ─── Toast ─── */
.toast{position:fixed;bottom:20px;right:20px;padding:10px 16px;border-radius:var(--radius);font-size:13px;font-weight:500;box-shadow:0 4px 12px oklch(0 0 0/.4);border:1px solid var(--border);background:var(--card);color:var(--card-fg);opacity:0;transform:translateY(8px);transition:all .2s;z-index:999;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}

/* ─── Permission dialog ─── */
.perm-mod-item{padding:8px 10px;font-size:13px;font-weight:500;cursor:pointer;border-radius:calc(var(--radius) - 2px);transition:background .1s;text-transform:capitalize;display:flex;align-items:center;gap:4px}
.perm-mod-item:hover{background:var(--accent)}
.perm-mod-item.active{background:var(--accent);color:var(--card-fg)}
.perm-tab{padding:8px 14px;font-size:13px;cursor:pointer;border-bottom:2px solid transparent;transition:all .1s;color:var(--muted-fg);white-space:nowrap}
.perm-tab:hover{color:var(--card-fg)}
.perm-tab.active{color:var(--card-fg);border-bottom-color:var(--primary)}
.perm-res-group{margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px}
.perm-res-group:last-child{border-bottom:none}
.perm-res-header{padding:4px 0;font-weight:500;font-size:13px}
.perm-row{padding:3px 0}
.perm-cb-label{display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;user-select:none}
.perm-cb-label input[type="checkbox"]{width:14px;height:14px;accent-color:var(--primary);cursor:pointer;flex-shrink:0}

/* ─── Switch toggle ─── */
.switch{position:relative;display:inline-block;width:36px;height:20px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:var(--muted);border-radius:20px;transition:.2s}
.slider::before{content:'';position:absolute;width:16px;height:16px;left:2px;bottom:2px;background:var(--card-fg);border-radius:50%;transition:.2s}
.switch input:checked+.slider{background:var(--success)}
.switch input:checked+.slider::before{transform:translateX(16px)}

/* ─── Badge ─── */
.badge{display:inline-flex;align-items:center;height:20px;padding:0 8px;border-radius:9999px;font-size:11px;font-weight:500}
.badge-outline{border:1px solid var(--border);color:var(--card-fg)}

@media(max-width:768px){.sidebar{display:none}.content{padding:16px}.mega-menu{min-width:280px;grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="logo" id="logoBtn">
    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    OpenERP
  </div>
  <div class="sep"></div>
  <div id="moduleButtons"></div>
  <div class="topbar-spacer"></div>
  <span class="user-name" id="userName">root</span>
  <button class="btn-ghost" id="logoutBtn">Logout</button>
</div>

<!-- Mega menu -->
<div class="mega-overlay" id="megaOverlay">
  <div class="mega-menu" id="megaMenu"></div>
</div>

<!-- Layout -->
<div class="layout">
  <aside class="sidebar" id="sidebar"></aside>
  <main class="content" id="content">
    <p style="color:var(--muted-fg)">Select a module to get started.</p>
  </main>
</div>

<!-- Create dialog -->
<div class="dialog-overlay" id="createDlg">
  <div class="dialog">
    <h2 id="dlgTitle">Create</h2>
    <form id="dlgForm"></form>
    <div class="dialog-footer">
      <button class="btn-sm-secondary" type="button" onclick="closeCreateDlg()">Cancel</button>
      <button class="btn-sm-primary" type="button" id="dlgSubmit" onclick="submitCreate()">Create</button>
    </div>
  </div>
</div>

<!-- Permission picker dialog -->
<div class="dialog-overlay" id="permDlg">
  <div class="dialog" style="max-width:640px;height:480px;display:flex;flex-direction:column;padding:0;overflow:hidden">
    <div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <h2 style="font-size:16px;font-weight:600;margin:0">Select Permissions</h2>
      <div style="display:flex;align-items:center;gap:12px">
        <span id="permDlgCount" style="font-size:13px;color:var(--muted-fg)">0 selected</span>
        <button class="btn-sm-secondary" type="button" onclick="closePermDlg()" style="height:30px;font-size:12px">Done</button>
      </div>
    </div>
    <div style="display:flex;flex:1;min-height:0;overflow:hidden">
      <!-- Left: module menu (fixed width, own scroll) -->
      <div id="permModMenu" style="width:110px;min-width:110px;border-right:1px solid var(--border);overflow-y:auto;padding:4px"></div>
      <!-- Right: tabs (fixed) + content (scrolls) -->
      <div style="flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden">
        <div id="permTabBar" style="display:flex;border-bottom:1px solid var(--border);padding:0 8px;flex-shrink:0"></div>
        <div id="permContent" style="flex:1;overflow-y:auto;padding:8px 12px"></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  const token=localStorage.getItem('openerp_token');
  if(!token){window.location.href='/';return}
  const H={'Authorization':'Bearer '+token,'Content-Type':'application/json'};

  // State
  let schema=null;
  let currentModule=null;
  let currentResource=null;

  // Helpers
  function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  async function api(m,p,b){const o={method:m,headers:H};if(b)o.body=JSON.stringify(b);const r=await fetch(p,o);if(r.status===401){localStorage.removeItem('openerp_token');window.location.href='/';return}if(r.status===204)return null;const d=await r.json();if(!r.ok)throw new Error(d.error||'Request failed');return d}
  function short(s){return s&&s.length>12?s.slice(0,12)+'\u2026':s||'\u2014'}

  // JWT decode
  try{const p=JSON.parse(atob(token.split('.')[1]));document.getElementById('userName').textContent=p.sub}catch(e){}

  // Logout
  document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('openerp_token');window.location.href='/'});

  // ── Load schema ──
  async function loadSchema(){
    schema=await api('GET','/meta/schema');
    buildModuleButtons();
    buildMegaMenu();
    if(schema.modules.length>0)selectModule(schema.modules[0].id);
  }

  // ── Module buttons in top bar ──
  function buildModuleButtons(){
    const c=document.getElementById('moduleButtons');c.innerHTML='';
    for(const mod of schema.modules){
      const btn=document.createElement('button');
      btn.className='module-btn';btn.dataset.id=mod.id;
      btn.textContent=mod.label;
      btn.addEventListener('click',()=>selectModule(mod.id));
      c.appendChild(btn);
    }
  }

  // ── Mega menu ──
  function buildMegaMenu(){
    const m=document.getElementById('megaMenu');m.innerHTML='';
    for(const mod of schema.modules){
      const div=document.createElement('div');div.className='mega-module';
      div.innerHTML='<h3>'+mod.label+'</h3>';
      for(const nav of mod.hierarchy.nav){
        const a=document.createElement('a');
        a.textContent=nav.label;
        a.addEventListener('click',()=>{closeMega();selectModule(mod.id);selectResource(nav.model)});
        div.appendChild(a);
      }
      m.appendChild(div);
    }
  }
  document.getElementById('logoBtn').addEventListener('click',()=>{
    document.getElementById('megaOverlay').classList.toggle('open');
  });
  document.getElementById('megaOverlay').addEventListener('click',function(e){if(e.target===this)closeMega()});
  function closeMega(){document.getElementById('megaOverlay').classList.remove('open')}

  // ── Select module ──
  function selectModule(id){
    currentModule=schema.modules.find(m=>m.id===id);
    if(!currentModule)return;
    // Highlight button
    document.querySelectorAll('.module-btn').forEach(b=>{b.classList.toggle('active',b.dataset.id===id)});
    // Build sidebar
    buildSidebar();
    // Select first resource
    if(currentModule.hierarchy.nav.length>0)selectResource(currentModule.hierarchy.nav[0].model);
  }

  // ── Sidebar ──
  function buildSidebar(){
    const s=document.getElementById('sidebar');s.innerHTML='';
    for(const nav of currentModule.hierarchy.nav){
      const item=document.createElement('div');item.className='nav-item';item.dataset.model=nav.model;
      item.textContent=nav.label;
      item.addEventListener('click',()=>selectResource(nav.model));
      s.appendChild(item);
    }
  }

  // ── Select resource ──
  function selectResource(modelName){
    const res=currentModule.resources.find(r=>r.name===modelName);
    if(!res)return;
    currentResource=res;
    // Highlight sidebar
    document.querySelectorAll('.sidebar .nav-item').forEach(i=>{i.classList.toggle('active',i.dataset.model===modelName)});
    // Build content
    buildResourcePage(res);
  }

  // ── Resource page ──
  function buildResourcePage(res){
    const c=document.getElementById('content');
    const navInfo=currentModule.hierarchy.nav.find(n=>n.model===res.name);
    const basePath='/admin/'+currentModule.id+'/'+pluralize(toSnake(res.name));

    c.innerHTML='<div class="section-header"><h2>'+(navInfo?.label||res.name)+'</h2>'
      +'<button class="btn-sm-primary" onclick="openCreateDlg()">+ Add</button></div>'
      +'<div class="table-card"><table><thead><tr id="resHead"></tr></thead>'
      +'<tbody id="resBody"><tr><td class="empty-cell" colspan="99">Loading\u2026</td></tr></tbody></table></div>';

    // Table headers
    const head=document.getElementById('resHead');
    const cols=res.fields.filter(f=>!f.name.endsWith('_at')).slice(0,6);
    for(const f of cols){head.innerHTML+='<th>'+f.name+'</th>'}
    head.innerHTML+='<th style="width:60px"></th>';

    // Load data
    loadResourceData(basePath,cols,res);
  }

  async function loadResourceData(basePath,cols,res){
    try{
      const d=await api('GET',basePath);
      const body=document.getElementById('resBody');
      const items=d.items||d;
      if(!items||!items.length){body.innerHTML='<tr><td class="empty-cell" colspan="99">No data</td></tr>';return}
      const pk=(res.key&&res.key.fields&&res.key.fields[0])||'id';
      body.innerHTML=items.map(item=>{
        let row='<tr>';
        for(const f of cols){
          let v=item[f.name]??item[toCamel(f.name)]??'\u2014';
          const w=(f.widget||'text').toLowerCase();
          if(typeof v==='boolean'){row+='<td>'+(v?'\u2705':'\u274c')+'</td>';continue}
          if(Array.isArray(v)){row+='<td>'+v.map(x=>'<span class="badge badge-outline" style="margin:1px">'+x+'</span>').join(' ')+'</td>';continue}
          if(typeof v==='object')v=JSON.stringify(v);
          if(f.name===pk||f.name==='id')row+='<td class="mono">'+short(String(v))+'</td>';
          else if(w==='email')row+='<td><a href="mailto:'+v+'" style="color:var(--card-fg);text-decoration:underline">'+v+'</a></td>';
          else if(w==='url'||w==='image')row+='<td><a href="'+v+'" target="_blank" style="color:var(--card-fg);text-decoration:underline">'+short(String(v))+'</a></td>';
          else row+='<td>'+String(v)+'</td>';
        }
        const id=item[pk]??item[toCamel(pk)]??item.id;
        row+='<td><button class="btn-ghost-destructive" onclick="deleteResource(\''+basePath+'\',\''+id+'\')">Delete</button></td>';
        return row+'</tr>';
      }).join('');
    }catch(e){toast(e.message)}
  }

  // ── Widget rendering ──
  function renderWidget(f){
    const raw=f.widget||'text';
    const w=raw.toLowerCase();
    const isOpt=f.ty&&(f.ty.startsWith('Option'));
    const label=f.name.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    const req=isOpt?'':' *';
    // Read params from schema (set by dsl/ui/ overrides).
    const ph=f.placeholder||f.name;
    const rows=f.rows||3;

    switch(w){
      case 'switch':
        return '<div class="field" style="flex-direction:row;align-items:center;gap:10px">'
          +'<label style="margin:0">'+label+'</label>'
          +'<label class="switch"><input type="checkbox" name="'+f.name+'" data-type="bool"><span class="slider"></span></label>'
          +'</div>';
      case 'textarea':case 'markdown':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<textarea name="'+f.name+'" rows="'+rows+'" placeholder="'+ph+'" style="width:100%;min-height:60px;padding:8px 10px;background:transparent;border:1px solid var(--input);border-radius:calc(var(--radius) - 2px);color:var(--card-fg);font-size:13px;font-family:inherit;resize:vertical"'
          +(isOpt?'':' required')+'></textarea></div>';
      case 'number':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input type="number" name="'+f.name+'" placeholder="'+(f.placeholder||'0')+'"'+(!isOpt?' required':'')+'></div>';
      case 'email':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input type="email" name="'+f.name+'" placeholder="'+(f.placeholder||'user@example.com')+'"'+(!isOpt?' required':'')+'></div>';
      case 'url':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input type="url" name="'+f.name+'" placeholder="'+(f.placeholder||'https://')+'"'+(!isOpt?' required':'')+'></div>';
      case 'password':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input type="password" name="'+f.name+'" placeholder="'+(f.placeholder||'\u2022\u2022\u2022\u2022\u2022\u2022')+'"'+(!isOpt?' required':'')+'></div>';
      case 'image':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input type="url" name="'+f.name+'" placeholder="'+(f.placeholder||'Image URL')+'"'+(!isOpt?' required':'')+'>'
          +'<span style="font-size:11px;color:var(--muted-fg)">Enter image URL or upload endpoint</span></div>';
      case 'datetime':case 'date':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input type="datetime-local" name="'+f.name+'" data-type="datetime"'+(!isOpt?' required':'')+'></div>';
      case 'tags':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input name="'+f.name+'" placeholder="Comma-separated values" data-type="tags"'+(!isOpt?' required':'')+'>'
          +'<span style="font-size:11px;color:var(--muted-fg)">Separate multiple values with commas</span></div>';
      case 'color':
        return '<div class="field" style="flex-direction:row;align-items:center;gap:10px">'
          +'<label style="margin:0">'+label+'</label>'
          +'<input type="color" name="'+f.name+'" style="width:40px;height:32px;padding:2px;cursor:pointer"></div>';
      case 'code':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<textarea name="'+f.name+'" rows="4" placeholder="JSON" data-type="json" style="width:100%;min-height:80px;padding:8px 10px;background:transparent;border:1px solid var(--input);border-radius:calc(var(--radius) - 2px);color:var(--card-fg);font-size:12px;font-family:monospace;resize:vertical"'
          +(isOpt?'':' required')+'></textarea></div>';
      case 'select':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<select name="'+f.name+'" data-type="select">'
          +'<option value="">Select...</option></select></div>';
      case 'permission_picker':
        return '<div class="field"><label>'+label+req+'</label>'
          +'<div style="display:flex;align-items:center;gap:8px">'
          +'<button type="button" class="btn-sm-secondary" onclick="openPermDlg(\''+f.name+'\')" style="flex-shrink:0">'
          +'Select Permissions</button>'
          +'<span class="perm-count" data-for="'+f.name+'" style="font-size:12px;color:var(--muted-fg)">0 selected</span>'
          +'</div>'
          +'<input type="hidden" name="'+f.name+'" data-type="perm_picker">'
          +'</div>';
      case 'hidden':case 'hidden':case 'readonly':case 'readonly':
        return '';// Don't show
      default:// Text
        return '<div class="field"><label>'+label+req+'</label>'
          +'<input name="'+f.name+'" placeholder="'+f.name+'"'+(!isOpt?' required':'')+'></div>';
    }
  }

  // ── Permission picker dialog ──
  let permFieldName=null;
  let permSelected=new Set();
  const PERM_TABS=[
    {id:'read',label:'Read',actions:['read']},
    {id:'list',label:'List',actions:['list']},
    {id:'edit',label:'Edit',actions:['create','update']},
    {id:'delete',label:'Delete',actions:['delete']},
    {id:'custom',label:'Custom',actions:null},// null = everything not in above
  ];
  const STANDARD_ACTIONS=['create','read','update','delete','list'];

  window.openPermDlg=function(fieldName){
    permFieldName=fieldName;
    permSelected=new Set();
    // Load existing selections from hidden input.
    const input=document.querySelector('input[name="'+fieldName+'"]');
    if(input&&input.value){try{JSON.parse(input.value).forEach(p=>permSelected.add(p))}catch(e){}}
    buildPermDlg();
    document.getElementById('permDlg').classList.add('open');
  };
  window.closePermDlg=function(){
    document.getElementById('permDlg').classList.remove('open');
    syncPermToForm();
  };

  let permActiveMod=null;
  let permActiveTab='read';

  function buildPermDlg(){
    if(!schema||!schema.permissions)return;
    const mods=Object.keys(schema.permissions);
    if(!permActiveMod)permActiveMod=mods[0];

    // Module menu (left)
    const modMenu=document.getElementById('permModMenu');
    modMenu.innerHTML='';
    for(const mod of mods){
      const cnt=countModPerms(mod);
      const item=document.createElement('div');
      item.className='perm-mod-item'+(mod===permActiveMod?' active':'');
      item.dataset.mod=mod;
      item.innerHTML='<span>'+mod+'</span><span style="margin-left:auto;font-size:11px;color:var(--muted-fg)">'+(cnt||'')+'</span>';
      item.addEventListener('click',()=>{permActiveMod=mod;buildPermDlg()});
      modMenu.appendChild(item);
    }

    // Tabs (top right)
    const tabBar=document.getElementById('permTabBar');
    tabBar.innerHTML='';
    for(const tab of PERM_TABS){
      const t=document.createElement('div');
      t.className='perm-tab'+(tab.id===permActiveTab?' active':'');
      t.textContent=tab.label;
      t.addEventListener('click',()=>{permActiveTab=tab.id;buildPermDlg()});
      tabBar.appendChild(t);
    }

    // Content (right) — new format: { resource: { label, description, actions: [{perm, action, desc}] } }
    const content=document.getElementById('permContent');
    content.innerHTML='';
    const resources=schema.permissions[permActiveMod]||{};
    const tab=PERM_TABS.find(t=>t.id===permActiveTab);

    // Flat list: one permission per line, no grouping headers.
    for(const[res,info] of Object.entries(resources)){
      const actions=info.actions||[];
      const resLabel=(info.label||res).replace(/s$/,''); // singular: Users->User
      const matching=actions.filter(a=>{
        if(tab.actions===null)return!STANDARD_ACTIONS.includes(a.action);
        return tab.actions.includes(a.action);
      });

      for(const a of matching){
        const row=document.createElement('div');row.className='perm-row';
        const checked=permSelected.has(a.perm);
        row.innerHTML='<label class="perm-cb-label">'
          +'<input type="checkbox" data-perm="'+a.perm+'" '+(checked?'checked':'')+'>'
          +'<span class="mono" style="min-width:160px;font-size:12px">'+resLabel+'.'+a.action+'</span>'
          +'<span style="color:var(--muted-fg);font-size:12px">'+a.desc+'</span>'
          +'</label>';
        row.querySelector('input').addEventListener('change',function(){
          if(this.checked)permSelected.add(a.perm);else permSelected.delete(a.perm);
          buildPermDlg();
        });
        content.appendChild(row);
      }
    }

    // Update count
    document.getElementById('permDlgCount').textContent=permSelected.size+' selected';
  }

  function countModPerms(mod){
    let n=0;
    for(const p of permSelected){if(p.startsWith(mod+':'))n++;}
    return n;
  }

  function syncPermToForm(){
    if(!permFieldName)return;
    const arr=[...permSelected];
    // Update hidden input
    const input=document.querySelector('input[name="'+permFieldName+'"]');
    if(input)input.value=JSON.stringify(arr);
    // Update count label
    const countEl=document.querySelector('.perm-count[data-for="'+permFieldName+'"]');
    if(countEl)countEl.textContent=arr.length+' selected';
  }

  // ── Create dialog ──
  window.openCreateDlg=function(){
    if(!currentResource)return;
    const dlg=document.getElementById('createDlg');
    const form=document.getElementById('dlgForm');
    document.getElementById('dlgTitle').textContent='Create '+currentResource.name;
    const editableFields=currentResource.fields.filter(f=>{
      const w=f.widget||'Text';
      const wl=(f.widget||'text').toLowerCase();
      return wl!=='hidden'&&wl!=='readonly'&&f.name!=='id'&&!f.name.endsWith('_at');
    });
    form.innerHTML=editableFields.map(renderWidget).join('');
    dlg.classList.add('open');
    // Initialize any permission pickers in the form.
    // Permission picker initialization is handled by openPermDlg() on button click.
    setTimeout(()=>{const inp=form.querySelector('input,textarea');if(inp)inp.focus()},100);
  };
  window.closeCreateDlg=function(){document.getElementById('createDlg').classList.remove('open')};
  window.submitCreate=async function(){
    if(!currentResource||!currentModule)return;
    const form=document.getElementById('dlgForm');
    const data={};
    for(const el of form.querySelectorAll('input,textarea,select')){
      const name=el.name;if(!name)continue;
      const dtype=el.dataset.type;
      if(dtype==='bool'){data[name]=el.checked;continue}
      if(dtype==='tags'){const v=el.value.trim();if(v)data[name]=v.split(',').map(s=>s.trim()).filter(Boolean);continue}
      if(dtype==='json'){const v=el.value.trim();if(v)try{data[name]=JSON.parse(v)}catch(e){data[name]=v};continue}
      const v=el.value.trim();
      if(v)data[name]=v;
    }
    // Collect permission pickers (from hidden input with JSON array).
    for(const input of form.querySelectorAll('input[data-type="perm_picker"]')){
      if(input.value){try{data[input.name]=JSON.parse(input.value)}catch(e){}}
    }
    const basePath='/admin/'+currentModule.id+'/'+pluralize(toSnake(currentResource.name));
    try{
      await api('POST',basePath,data);
      closeCreateDlg();toast(currentResource.name+' created');
      selectResource(currentResource.name);
    }catch(e){toast(e.message)}
  };

  // ── Delete ──
  window.deleteResource=async function(basePath,id){
    if(!confirm('Delete this record?'))return;
    try{await api('DELETE',basePath+'/'+id);toast('Deleted');selectResource(currentResource.name)}catch(e){toast(e.message)}
  };

  // ── Util ──
  function toSnake(s){return s.replace(/([A-Z])/g,(m,c,i)=>(i?'_':'')+c.toLowerCase())}
  function toCamel(s){return s.replace(/_([a-z])/g,(_,c)=>c.toUpperCase())}
  function pluralize(s){
    if(s.endsWith('s')||s.endsWith('sh')||s.endsWith('ch')||s.endsWith('x'))return s+'es';
    if(s.endsWith('y')&&!s.endsWith('ey'))return s.slice(0,-1)+'ies';
    return s+'s';
  }

  // Close dialogs on Escape
  document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeCreateDlg();closeMega();closePermDlg()}});
  document.getElementById('permDlg').addEventListener('click',function(e){if(e.target===this)closePermDlg()});

  // Go
  loadSchema();
})();
</script>
</body>
</html>
